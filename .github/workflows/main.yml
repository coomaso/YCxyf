name: å®œæ˜Œå¸‚ä¿¡ç”¨æ•°æ®è‡ªåŠ¨é‡‡é›†

on:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤©UTCæ—¶é—´20:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥04:00ï¼‰
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  data-collect:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pycryptodome==3.19.1 requests==2.31.0 openpyxl==3.1.2

    - name: æ‰§è¡Œæ•°æ®é‡‡é›†
      id: export
      run: |
        # ç”Ÿæˆæ—¶é—´æˆ³
        ts=$(date +%Y%m%d%H%M)
        echo "ts=${ts}" >> $GITHUB_OUTPUT

        # æ¸…ç†æ—§æ–‡ä»¶
        mkdir -p excel_output
        find excel_output/ -maxdepth 1 -type f \( -name "*.xlsx" -o -name "*.json" \) -delete

        # æ‰§è¡Œä¸»è„šæœ¬
        python3 main.py

        # é‡å‘½åExcelæ–‡ä»¶
        original_file=$(ls excel_output/*.xlsx | head -n 1)
        new_file="excel_output/å®œæ˜Œå¸‚ä¿¡ç”¨æ•°æ®_${ts}.xlsx"
        [ -f "$original_file" ] && mv "$original_file" "$new_file"

        # æ£€æŸ¥Excelæ–‡ä»¶æ˜¯å¦æˆåŠŸç”Ÿæˆ
        if [ ! -f "$new_file" ]; then
            echo "::error:: æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
        fi

        echo "file-path=${new_file}" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ Excelæ•°æ®æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: enterprise-data
        path: ${{ steps.export.outputs.file-path }}
        retention-days: 7

    - name: æäº¤åˆ°ä»“åº“
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        ts="${{ steps.export.outputs.ts }}"
        filename=$(basename "${{ steps.export.outputs.file-path }}")
        month_dir=$(date +'%Y-%m')

        # åˆ›å»ºç›®æ ‡ç›®å½•
        mkdir -p "historical_X_data/$month_dir"
        mkdir -p "historical_J_data/$month_dir"

        # å¤åˆ¶ Excel æ–‡ä»¶
        cp "${{ steps.export.outputs.file-path }}" "historical_X_data/$month_dir/$filename"

        # å¤åˆ¶ JSON æ–‡ä»¶ï¼ˆå¦‚å­˜åœ¨ï¼‰
        json_file=$(ls excel_output/*.json 2>/dev/null | head -n 1)
        if [ -f "$json_file" ]; then
          json_filename=$(basename "$json_file")
          cp "$json_file" "historical_J_data/$month_dir/$json_filename"
        else
          echo "âš ï¸ æœªæ‰¾åˆ° JSON æ–‡ä»¶ï¼Œè·³è¿‡å½’æ¡£"
        fi

        git add .

        if git diff --cached --quiet; then
          echo "âœ… æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          git commit -m "ğŸ“Š ä¿¡ç”¨æ•°æ®æ›´æ–° [${ts}]"
          git push origin main
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
